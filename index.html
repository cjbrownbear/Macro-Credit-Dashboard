<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Macro–Credit Stress Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --good:#22c55e;
      --warn:#facc15;
      --bad:#ef4444;
      --border: rgba(255,255,255,0.10);
      --shadow: rgba(0,0,0,0.35);
    }
    body{
      margin:0; padding:24px;
      background: linear-gradient(180deg, #0b0f19 0%, #070a12 100%);
      color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Arial,sans-serif;
    }
    .wrap{ max-width: 1180px; margin: 0 auto; }
    h1{ margin:0 0 6px 0; font-size: 22px; letter-spacing:0.2px; }
    h2{ font-size: 15px; margin: 0 0 10px 0; }
    .toprow{ display:flex; justify-content: space-between; align-items:flex-start; gap: 16px; }
    .desc{ margin:0; color: var(--muted); font-size: 13px; line-height: 1.45; max-width: 880px; }
    code{ background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 8px; }

    .overall{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      font-weight: 950;
      font-size: 12px;
      white-space: nowrap;
      flex: 0 0 auto;
      align-self: flex-start;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .overall.good{ color: var(--good); }
    .overall.warn{ color: var(--warn); }
    .overall.bad{ color: var(--bad); }

    .section{ margin-top: 18px; }
    .legend{ display:flex; gap:10px; margin: 10px 0 10px 0; flex-wrap:wrap; }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      font-size:12px;
      background: rgba(255,255,255,0.02);
    }
    .pill.healthy{ color: var(--good); }
    .pill.tripwire{ color: var(--warn); }
    .pill.stress{ color: var(--bad); }

    .execsum{
      background: rgba(17,24,39,0.78);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 30px var(--shadow);
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
    }
    .execmeta{ margin-top: 8px; color: var(--muted); font-size: 12px; }

    .newsgrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    .newscard{
      background: rgba(17,24,39,0.70);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 30px var(--shadow);
      min-height: 118px;
    }
    .newstitle{ font-weight: 950; font-size: 13px; margin-bottom: 6px; }
    .newsitem{ margin: 8px 0; }
    .newsitem a{ color: var(--text); text-decoration: none; font-size: 12px; line-height: 1.35; }
    .newsitem a:hover{ text-decoration: underline; }
    .newssrc{ color: var(--muted); font-size: 11px; margin-top: 2px; }

    .kpigrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .kpicard{
      background: rgba(17,24,39,0.78);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 30px var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .kpihead{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .kpihead > div{ min-width: 0; }
    .kpititle{
      font-weight: 950;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
    }
    .kpititle span.label{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 100%;
    }
    .info{
      width: 18px; height: 18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      color: rgba(229,231,235,0.9);
      font-size: 11px;
      font-weight: 950;
      flex: 0 0 auto;
      cursor: default;
    }
    .kpisub{ color: var(--muted); font-size: 12px; margin-top: 3px; }
    .badge{
      font-size: 11px;
      font-weight: 950;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      white-space: nowrap;
      flex: 0 0 auto;
      max-width: 132px;
      text-align:center;
    }
    .badge.healthy{ color: var(--good); }
    .badge.tripwire{ color: var(--warn); }
    .badge.stress{ color: var(--bad); }

    .kpivalue{ font-size: 22px; font-weight: 980; margin-top: 10px; }
    .kpimeta{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.3;
    }
    .kpisparkwrap{ margin-top: 10px; }
    svg.spark{ width: 100%; height: 44px; display:block; }
    .sparkline{ fill:none; stroke: rgba(229,231,235,0.92); stroke-width: 2; }
    .sparkaxis{ stroke: rgba(255,255,255,0.07); stroke-width: 1; }

    /* KPI hover popup */
    .kpiPopup{
      position:absolute;
      left: 12px;
      right: 12px;
      top: 46px;
      background: rgba(0,0,0,0.82);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
      color: var(--text);
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 120ms linear, transform 120ms linear;
      pointer-events: none;
      z-index: 20;
    }
    .kpicard:hover .kpiPopup{ opacity: 1; transform: translateY(0px); }
    .kpiPopup .ptitle{ font-weight: 950; margin-bottom: 6px; }
    .kpiPopup .pmuted{ color: rgba(229,231,235,0.70); }

    /* Trends + window controls */
    .windowbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,0.55);
      margin-top: 8px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .windowbar .left{ color: var(--muted); font-size: 12px; }
    .windowbar input[type="range"]{ width: 380px; max-width: 42vw; }
    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
    }
    .btn:hover{ background: rgba(255,255,255,0.06); }

    .trendgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 900px){
      .trendgrid{ grid-template-columns: 1fr; }
    }
    .trendcard{
      background: rgba(17,24,39,0.70);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 30px var(--shadow);
    }
    .trendhead{ display:flex; justify-content: space-between; gap: 12px; }
    .trendtitle{ font-weight: 950; font-size: 13px; }
    .trendmeta{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .trenddef{ color: rgba(229,231,235,0.78); font-size: 12px; margin-top: 6px; line-height: 1.35; }
    .trendSummary{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(229,231,235,0.90);
      font-size: 12px;
      line-height: 1.35;
    }
    .chartwrap{ margin-top: 10px; position: relative; }
    canvas{ width: 100%; height: 220px; }
    .hoverbox{
      position:absolute;
      pointer-events:none;
      background: rgba(0,0,0,0.82);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text);
      transform: translate(-50%, -110%);
      display:none;
      white-space: nowrap;
    }
    .downloads{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 10px; }
    .footnote{ color: var(--muted); font-size: 12px; margin-top: 8px; }

    /* Dotted benchmark / average line style */
    .benchLegend{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap: 14px;
      flex-wrap:wrap;
      align-items:center;
    }
    .legLine{
      width: 26px;
      height: 0;
      border-top: 2px solid rgba(229,231,235,0.9);
      display:inline-block;
      margin-right: 6px;
      border-radius: 2px;
    }
    .legDash{
      border-top-style: dashed;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="toprow">
      <div>
        <h1>Macro–Credit Stress Dashboard</h1>
        <p class="desc" id="headlineDesc">
          A continuously-updated snapshot of consumer credit stress, household leverage, housing conditions, and labor market softness using public macro series (primarily FRED).
          KPI tiles show the latest reading, a 10-year baseline, and true YoY movement (in clear units—percentage points for rate series). Hover a tile for “why” the health status is what it is.
          (<span id="lastUpdated">Last updated: —</span>)
        </p>
      </div>
      <div class="overall" id="overallBadge">Overall: —</div>
    </div>

    <div class="section">
      <h2>Executive summary</h2>
      <div class="execsum" id="execSummary">—</div>
      <div class="execmeta" id="execMeta">Last updated: —</div>
    </div>

    <div class="section">
      <h2>Latest headlines</h2>
      <div class="newsgrid" id="newsGrid">
        <div class="newscard"><div class="newstitle">Credit / consumer stress</div><div class="newsitem"><span class="newssrc">Loading <code>news.json</code>…</span></div></div>
        <div class="newscard"><div class="newstitle">Labor / macro signals</div><div class="newsitem"><span class="newssrc">Loading <code>news.json</code>…</span></div></div>
      </div>

      <div class="legend">
        <span class="pill healthy">Healthy</span>
        <span class="pill tripwire">Tripwire / Watch</span>
        <span class="pill stress">Stress</span>
      </div>
    </div>

    <div class="section">
      <h2>Latest snapshot</h2>
      <div class="kpigrid" id="kpiGrid"></div>
    </div>

    <div class="section">
      <h2>Trends (interactive)</h2>

      <div class="windowbar">
        <div class="left" id="windowLabel">View window: —</div>
        <div class="mid">
          <input type="range" min="0" max="100" value="100" id="windowSlider" />
        </div>
        <div class="right">
          <button class="btn" id="latestBtn">Latest</button>
        </div>
      </div>

      <div class="benchLegend">
        <span><span class="legLine"></span>Series</span>
        <span><span class="legLine legDash"></span>10y avg / benchmark</span>
      </div>

      <div class="trendgrid" id="trendGrid"></div>

      <div class="downloads">
        <a class="btn" href="data.json" download>Download data.json</a>
        <a class="btn" href="news.json" download>Download news.json</a>
        <a class="btn" href="macro_credit_timeseries.xlsx" download>Download Excel (metrics + timeseries)</a>
        <a class="btn" href="macro_credit_metrics.xlsx" download>Download Excel (metrics)</a>
      </div>
      <div class="footnote">If something doesn’t load: confirm <code>index.html</code>, <code>data.json</code>, and <code>news.json</code> are in the repo root.</div>
    </div>

  </div>

<script>
  const DATA_URL = 'data.json';
  const NEWS_URL = 'news.json';

  // ---------- Formatting ----------
  function fmtDate(s){
    if(!s) return '—';
    try{
      const d = new Date(s);
      const opts = {year:'numeric', month:'short'};
      return d.toLocaleDateString(undefined, opts);
    }catch(e){ return s; }
  }
  function fmtNumber(x, unit){
    if(x === null || x === undefined) return '—';
    if(typeof x !== 'number') x = Number(x);
    if(!isFinite(x)) return '—';

    // Percent / percentage points formatting
    if(unit === 'pct'){
      return x.toFixed(2) + '%';
    }
    if(unit === 'pp'){ // already in percentage points
      const sign = x >= 0 ? '+' : '';
      return sign + x.toFixed(2) + 'pp';
    }

    // Thousands (claims)
    if(unit === 'thou'){
      // x is already "thousands of persons"
      // Display as "236K" not "236,000K"
      const rounded = Math.round(x);
      return rounded.toLocaleString() + 'K';
    }

    // Millions
    if(unit === 'mil'){
      return (x).toFixed(2) + 'M';
    }

    // Dollars (billions)
    if(unit === 'usd_b'){
      // x is billions of dollars; show as $1,317B not $1,316,781B
      const rounded = Math.round(x);
      return '$' + rounded.toLocaleString() + 'B';
    }

    // Generic
    return x.toLocaleString(undefined, {maximumFractionDigits: 2});
  }

  function fmtDelta(deltaAbs, deltaPct, unit){
    // unit: pct => abs is pp, pct is percent change (vs prior)
    // unit: mil => abs in M, pct in %
    if(deltaAbs === null || deltaAbs === undefined) return 'Δ 1y: —';

    const absStr = (unit === 'pct')
      ? ((deltaAbs>=0?'+':'') + deltaAbs.toFixed(2) + 'pp')
      : (unit === 'usd_b')
        ? ((deltaAbs>=0?'+':'') + '$' + Math.round(deltaAbs).toLocaleString() + 'B')
        : (unit === 'mil')
          ? ((deltaAbs>=0?'+':'') + deltaAbs.toFixed(2) + 'M')
          : (unit === 'thou')
            ? ((deltaAbs>=0?'+':'') + Math.round(deltaAbs).toLocaleString() + 'K')
            : ((deltaAbs>=0?'+':'') + deltaAbs.toFixed(2));

    let pctStr = '';
    if(deltaPct !== null && deltaPct !== undefined && isFinite(deltaPct)){
      const s = (deltaPct>=0?'+':'') + (deltaPct*100).toFixed(1) + '%';
      pctStr = ` (${s})`;
    }
    return `Δ 1y: ${absStr}${pctStr}`;
  }

  function cssStatus(status){
    if(status === 'healthy') return 'healthy';
    if(status === 'tripwire') return 'tripwire';
    return 'stress';
  }

  // ---------- Simple sparkline ----------
  function sparkSVG(values){
    const w = 300, h = 44, pad = 4;
    const clean = values.filter(v => typeof v === 'number' && isFinite(v));
    if(clean.length < 2){
      return `<svg class="spark" viewBox="0 0 ${w} ${h}">
        <line class="sparkaxis" x1="${pad}" y1="${h-8}" x2="${w-pad}" y2="${h-8}" />
      </svg>`;
    }
    const min = Math.min(...clean), max = Math.max(...clean);
    const denom = (max-min) === 0 ? 1 : (max-min);
    let d = '';
    values.forEach((v, i) => {
      if(typeof v !== 'number' || !isFinite(v)) return;
      const x = pad + (i/(values.length-1))*(w-2*pad);
      const y = pad + (1 - (v-min)/denom)*(h-2*pad);
      d += (d===''?`M ${x} ${y}`:` L ${x} ${y}`);
    });
    return `<svg class="spark" viewBox="0 0 ${w} ${h}">
      <line class="sparkaxis" x1="${pad}" y1="${h-8}" x2="${w-pad}" y2="${h-8}" />
      <path class="sparkline" d="${d}" />
    </svg>`;
  }

  // ---------- Lightweight canvas chart with hover + 10y avg dotted line ----------
  function drawChart(canvas, series, benchSeries, opts){
    const ctx = canvas.getContext('2d');
    const parent = canvas.parentElement;
    let hover = parent.querySelector('.hoverbox');
    if(!hover){
      hover = document.createElement('div');
      hover.className = 'hoverbox';
      parent.appendChild(hover);
    }

    const W = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
    const H = canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
    ctx.clearRect(0,0,W,H);

    const padL=44, padR=18, padT=12, padB=26;
    const xs = series.map(p=>p.date.getTime());
    const ys = series.map(p=>p.value);
    const minX = Math.min(...xs), maxX=Math.max(...xs);
    const minY = Math.min(...ys), maxY=Math.max(...ys);
    const yPad = (maxY-minY)*0.08 || 1;
    const y0 = minY - yPad, y1 = maxY + yPad;

    function xTo(t){
      return padL + ( (t-minX) / (maxX-minX || 1) ) * (W-padL-padR);
    }
    function yTo(v){
      return padT + (1 - ( (v-y0) / (y1-y0 || 1) )) * (H-padT-padB);
    }

    // grid
    ctx.strokeStyle = 'rgba(255,255,255,0.07)';
    ctx.lineWidth = 1;
    for(let i=0;i<3;i++){
      const yy = padT + i*(H-padT-padB)/2;
      ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(W-padR,yy); ctx.stroke();
    }

    // benchmark dotted line
    if(benchSeries && benchSeries.length){
      ctx.save();
      ctx.strokeStyle = 'rgba(229,231,235,0.55)';
      ctx.setLineDash([6,5]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      benchSeries.forEach((p, i) => {
        const xx = xTo(p.date.getTime());
        const yy = yTo(p.value);
        if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
      });
      ctx.stroke();
      ctx.restore();
    }

    // main line
    ctx.strokeStyle = 'rgba(229,231,235,0.92)';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    series.forEach((p, i) => {
      const xx = xTo(p.date.getTime());
      const yy = yTo(p.value);
      if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
    });
    ctx.stroke();

    // hover
    canvas.onmousemove = (ev)=>{
      const rect = canvas.getBoundingClientRect();
      const x = (ev.clientX-rect.left) * (window.devicePixelRatio || 1);
      const t = minX + ((x - padL)/(W-padL-padR))*(maxX-minX);
      // nearest
      let best = 0, bestD = Infinity;
      for(let i=0;i<xs.length;i++){
        const d = Math.abs(xs[i]-t);
        if(d<bestD){ bestD=d; best=i; }
      }
      const pt = series[best];
      const hx = xTo(pt.date.getTime());
      const hy = yTo(pt.value);

      hover.style.display = 'block';
      hover.style.left = (hx/(window.devicePixelRatio||1))+'px';
      hover.style.top  = (hy/(window.devicePixelRatio||1))+'px';
      hover.textContent = `${opts.label}: ${pt.valueStr} • ${pt.dateStr}`;
    };
    canvas.onmouseleave = ()=>{
      hover.style.display = 'none';
    };
  }

  // ---------- Data + Rendering ----------
  let ALL = null;
  let WINDOW_START_IDX = 0;
  let WINDOW_SIZE = 0;

  function computeWindowBounds(allDates){
    // 10-year window (by months): if monthly-like data, ~120 points; if weekly, different.
    // We'll use date arithmetic: windowStartDate = endDate - 10y, then find earliest idx >= windowStartDate.
    const end = allDates[allDates.length-1];
    const start = new Date(end);
    start.setFullYear(start.getFullYear()-10);
    let idx = 0;
    for(let i=0;i<allDates.length;i++){
      if(allDates[i] >= start){ idx=i; break; }
    }
    return idx;
  }

  function overallBadge(status){
    const el = document.getElementById('overallBadge');
    el.classList.remove('good','warn','bad');
    if(status === 'healthy'){ el.classList.add('good'); el.textContent = 'Overall: Healthy'; }
    else if(status === 'tripwire'){ el.classList.add('warn'); el.textContent = 'Overall: Tripwire / Watch'; }
    else { el.classList.add('bad'); el.textContent = 'Overall: Stress'; }
  }

  function renderExecutive(summaryObj){
    const el = document.getElementById('execSummary');
    const meta = document.getElementById('execMeta');
    if(!summaryObj){
      el.textContent = '—';
      meta.textContent = 'Last updated: —';
      return;
    }
    el.textContent = summaryObj.text || '—';
    meta.textContent = `Last updated: ${summaryObj.updated || '—'}`;
  }

  function renderKpis(kpis){
    const grid = document.getElementById('kpiGrid');
    grid.innerHTML = '';
    kpis.forEach(k=>{
      const card = document.createElement('div');
      card.className = 'kpicard';

      const statusCls = cssStatus(k.status);
      const badge = `<span class="badge ${statusCls}">${k.status_label || k.status}</span>`;

      const title = `
        <div class="kpihead">
          <div>
            <div class="kpititle">
              <span class="label">${k.title}</span>
              <span class="info" title="Hover the tile for details">i</span>
            </div>
            <div class="kpisub">${k.subtitle || ''}</div>
          </div>
          ${badge}
        </div>
      `;

      const value = `<div class="kpivalue">${k.value_str || '—'}</div>`;

      const meta = `
        <div class="kpimeta">
          <div>As of: <b>${k.as_of || '—'}</b></div>
          <div>10y avg: <b>${k.avg_str || '—'}</b></div>
        </div>
      `;

      const delta = `<div class="kpimeta" style="margin-top:8px;">
        <div>${k.delta_str || 'Δ 1y: —'}</div>
      </div>`;

      const spark = `
        <div class="kpisparkwrap">
          ${sparkSVG((k.spark || []).map(v => (typeof v === 'number' && isFinite(v)) ? v : null))}
        </div>
      `;

      const popup = `
        <div class="kpiPopup">
          <div class="ptitle">${k.title} — Why this is ${k.status_label || k.status}</div>
          <div class="pmuted">${k.definition || ''}</div>
          <div style="margin-top:8px;">${k.why || ''}</div>
        </div>
      `;

      card.innerHTML = title + value + meta + spark + delta + popup;
      grid.appendChild(card);
    });
  }

  function renderNews(news){
    const grid = document.getElementById('newsGrid');
    grid.innerHTML = '';

    if(!news || !news.sections || !news.sections.length){
      const c = document.createElement('div');
      c.className = 'newscard';
      c.innerHTML = `<div class="newstitle">News feed</div><div class="newsitem"><span class="newssrc">No headlines available.</span></div>`;
      grid.appendChild(c);
      return;
    }

    news.sections.forEach(sec=>{
      const card = document.createElement('div');
      card.className = 'newscard';
      card.innerHTML = `<div class="newstitle">${sec.title || 'News'}</div>`;
      const items = (sec.items || []).slice(0,5);
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'newsitem';
        const when = it.published ? new Date(it.published).toUTCString().replace('GMT','UTC') : '';
        div.innerHTML = `
          <div><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></div>
          <div class="newssrc">${it.source || ''}${when ? ' • ' + when : ''}</div>
        `;
        card.appendChild(div);
      });
      if(!items.length){
        const div = document.createElement('div');
        div.className = 'newsitem';
        div.innerHTML = `<span class="newssrc">No headlines available.</span>`;
        card.appendChild(div);
      }
      grid.appendChild(card);
    });
  }

  function renderTrends(trends, windowStart){
    const grid = document.getElementById('trendGrid');
    grid.innerHTML = '';

    trends.forEach(t=>{
      const card = document.createElement('div');
      card.className = 'trendcard';

      const head = document.createElement('div');
      head.className = 'trendhead';
      head.innerHTML = `
        <div>
          <div class="trendtitle">${t.title}</div>
          <div class="trendmeta">${t.subtitle || ''}</div>
          <div class="trenddef">${t.definition || ''}</div>
          <div class="trendSummary" id="sum_${t.key}">—</div>
        </div>
        <div class="trendmeta" style="text-align:right;">${t.source || ''}</div>
      `;

      const wrap = document.createElement('div');
      wrap.className = 'chartwrap';
      const canvas = document.createElement('canvas');
      canvas.style.height = '220px';
      wrap.appendChild(canvas);

      card.appendChild(head);
      card.appendChild(wrap);
      grid.appendChild(card);

      // window slice
      const pts = (t.points || []).filter(p => p.date && typeof p.value === 'number' && isFinite(p.value))
        .map(p => ({
          date: new Date(p.date),
          value: p.value,
          valueStr: p.value_str || String(p.value),
          dateStr: fmtDate(p.date)
        }));

      const bench = (t.bench_points || []).filter(p => p.date && typeof p.value === 'number' && isFinite(p.value))
        .map(p => ({
          date: new Date(p.date),
          value: p.value
        }));

      const ptsWin = pts.filter(p => p.date >= windowStart);
      const benchWin = bench.filter(p => p.date >= windowStart);

      // summary text
      const summaryEl = document.getElementById(`sum_${t.key}`);
      summaryEl.textContent = t.summary_text || '—';

      // draw
      if(ptsWin.length >= 2){
        drawChart(canvas, ptsWin, benchWin, {label: t.title});
      }else{
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
        canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
        ctx.fillStyle = 'rgba(229,231,235,0.65)';
        ctx.font = `${12*(window.devicePixelRatio||1)}px -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Arial,sans-serif`;
        ctx.fillText('No data available.', 12*(window.devicePixelRatio||1), 22*(window.devicePixelRatio||1));
      }
    });
  }

  function updateWindowLabel(startDate, endDate){
    const el = document.getElementById('windowLabel');
    el.textContent = `View window: ${fmtDate(startDate.toISOString())} → ${fmtDate(endDate.toISOString())} (10-year window, drag slider or scroll on a chart)`;
  }

  async function main(){
    let data = null;
    let news = null;

    try{
      const r = await fetch(DATA_URL, {cache:'no-store'});
      data = await r.json();
    }catch(e){
      console.error('Failed to load data.json', e);
    }

    try{
      const r2 = await fetch(NEWS_URL, {cache:'no-store'});
      news = await r2.json();
    }catch(e){
      console.error('Failed to load news.json', e);
    }

    if(!data){
      document.getElementById('execSummary').textContent = 'Data failed to load.';
      return;
    }

    ALL = data;

    document.getElementById('lastUpdated').textContent = `Last updated: ${data.updated || '—'}`;
    renderExecutive(data.executive_summary);
    overallBadge(data.overall_status || 'tripwire');
    renderNews(news);

    // KPI tiles
    renderKpis(data.kpis || []);

    // Trends
    const allDates = (data.all_dates || []).map(d => new Date(d)).filter(d=>!isNaN(d));
    if(allDates.length){
      const startIdx = computeWindowBounds(allDates);
      WINDOW_START_IDX = startIdx;
      WINDOW_SIZE = allDates.length - startIdx;

      const slider = document.getElementById('windowSlider');
      slider.value = 100;

      let windowStart = allDates[startIdx];
      let windowEnd = allDates[allDates.length-1];
      updateWindowLabel(windowStart, windowEnd);
      renderTrends(data.trends || [], windowStart);

      slider.oninput = ()=>{
        const pct = Number(slider.value)/100;
        // Move window start within the available span while keeping 10y-sized window in date terms.
        // We'll pick a pivot date and recompute 10y back from it.
        const pivot = allDates[Math.floor(pct*(allDates.length-1))];
        const ws = new Date(pivot);
        ws.setFullYear(ws.getFullYear()-10);
        windowStart = ws;
        windowEnd = pivot;
        updateWindowLabel(windowStart, windowEnd);
        renderTrends(data.trends || [], windowStart);
      };

      document.getElementById('latestBtn').onclick = ()=>{
        slider.value = 100;
        const pivot = allDates[allDates.length-1];
        const ws = new Date(pivot);
        ws.setFullYear(ws.getFullYear()-10);
        windowStart = ws;
        windowEnd = pivot;
        updateWindowLabel(windowStart, windowEnd);
        renderTrends(data.trends || [], windowStart);
      };
    }else{
      document.getElementById('trendGrid').innerHTML = '<div class="trendcard">No time series available.</div>';
    }
  }

  main();
</script>
</body>
</html>
